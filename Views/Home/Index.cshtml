@model List<SistemaBiblioteca.Models.MaterialBibliografico>
@{
    ViewData["Title"] = "Inicio";
}

<h1 class="text-center mb-4">Buscar Libros</h1>

<!-- Filtros dinámicos -->
<div class="mb-4">
    <div class="row g-2" id="filtros">
        <div class="col-md-3">
            <input type="text" id="filtroTitulo" class="form-control" placeholder="Título" />
        </div>
        <div class="col-md-3">
            <input type="text" id="filtroAutor" class="form-control" placeholder="Autor" />
        </div>
        <div class="col-md-3">
            <input type="text" id="filtroMateria" class="form-control" placeholder="Materia" />
        </div>
        <div class="col-md-1">
            <button id="btnReset" class="btn btn-secondary w-100">Limpiar</button>
        </div>
    </div>
</div>

<!-- Tabla de resultados -->
@if (Model != null && Model.Any())
{
    <table id="tablaMateriales" class="table table-bordered table-hover">
        <thead>
            <tr>
                <th onclick="ordenarTabla(0)">Título</th>
                <th onclick="ordenarTabla(1)">Autor</th>
                <th onclick="ordenarTabla(2)">Materia</th>
                <th onclick="ordenarTabla(3)">Cantidad disponible</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var libro in Model)
            {
                <tr>
                    <td>@libro.Titulo</td>
                    <td>@libro.Autor</td>
                    <td>@string.Join(", ", libro.Materias)</td>
                    <td class="@(libro.Cantidad == 0 ? "text-danger fw-bold" : "")">
                        @(libro.Cantidad > 0 ? libro.Cantidad.ToString() : "Agotado")
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-muted mt-4">No se encontraron libros con esos criterios.</p>
}

<!-- Scripts para filtrado y ordenamiento -->
<script>
    let direccionOrden = {};

    function ordenarTabla(columnaIndex) {
        const tabla = document.getElementById("tablaMateriales");
        const tbody = tabla.tBodies[0];
        const filas = Array.from(tbody.rows);

        direccionOrden[columnaIndex] = !direccionOrden[columnaIndex];

        filas.sort((a, b) => {
            let valorA = a.cells[columnaIndex].innerText.trim().toLowerCase();
            let valorB = b.cells[columnaIndex].innerText.trim().toLowerCase();

            if (!isNaN(valorA) && !isNaN(valorB)) {
                valorA = parseFloat(valorA);
                valorB = parseFloat(valorB);
            }

            if (valorA < valorB) return direccionOrden[columnaIndex] ? -1 : 1;
            if (valorA > valorB) return direccionOrden[columnaIndex] ? 1 : -1;
            return 0;
        });

        filas.forEach(fila => tbody.appendChild(fila));
    }

    function filtrarTabla() {
        const titulo = document.getElementById('filtroTitulo').value.toLowerCase();
        const autor = document.getElementById('filtroAutor').value.toLowerCase();
        const materia = document.getElementById('filtroMateria').value.toLowerCase();

        const filas = document.querySelectorAll("#tablaMateriales tbody tr");

        filas.forEach(fila => {
            const cTitulo = fila.cells[0].innerText.toLowerCase();
            const cAutor = fila.cells[1].innerText.toLowerCase();
            const cMateria = fila.cells[2].innerText.toLowerCase();

            const coincide =
                cTitulo.includes(titulo) &&
                cAutor.includes(autor) &&
                cMateria.includes(materia);

            fila.style.display = coincide ? "" : "none"; // 👈 esto es lo que faltaba
        });
    }

    // Eventos en tiempo real
    document.getElementById('filtroTitulo').addEventListener('input', filtrarTabla);
    document.getElementById('filtroAutor').addEventListener('input', filtrarTabla);
    document.getElementById('filtroMateria').addEventListener('input', filtrarTabla);

    document.getElementById('btnReset').addEventListener('click', function (e) {
        e.preventDefault();
        document.getElementById('filtroTitulo').value = "";
        document.getElementById('filtroAutor').value = "";
        document.getElementById('filtroMateria').value = "";
        filtrarTabla();
    });
</script>
