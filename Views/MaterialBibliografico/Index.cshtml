@model IEnumerable<SistemaBiblioteca.Models.MaterialBibliografico>

@{
    ViewData["Title"] = "📚 Catálogo de Libros";
}

<h1 class="mb-4">📚 Catálogo de Libros</h1>

@if (ViewBag.HayPrestamosVencidos)
{
    <div class="alert alert-warning d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        ⚠️ ¡Hay préstamos vencidos! Revisá el listado de préstamos.
    </div>
}

<div class="mb-4 d-flex flex-wrap gap-2">
    <a asp-action="Create" class="btn btn-primary">
        ➕ Crear nuevo libro
    </a>
    <button type="button" id="btnExportarExcel" class="btn btn-success">
        📘 Exportar biblioteca completa a Excel
    </button>
</div>

<!-- Filtros predictivos -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="tituloInput" class="form-label">Título:</label>
        <input type="text" id="tituloInput" class="form-control" placeholder="Buscar por título">
    </div>
    <div class="col-md-3">
        <label for="autorInput" class="form-label">Autor:</label>
        <input type="text" id="autorInput" class="form-control" placeholder="Buscar por autor">
    </div>
    <div class="col-md-2">
        <label for="materiaSelect" class="form-label">Materia:</label>
        <select id="materiaSelect" name="materia" class="form-select">
            <option value="">-- Todas --</option>
            @foreach (var mat in ViewBag.Materias as List<string>)
            {
                <option value="@mat" selected="@(ViewBag.MateriaSeleccionada == mat ? "selected" : null)">
                    @mat
                </option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label for="estadoSelect" class="form-label">Estado:</label>
        <select id="estadoSelect" name="estado" class="form-select">
            <option value="">-- Todos --</option>
            <option value="Disponible" selected="@(ViewBag.EstadoSeleccionado == "Disponible" ? "selected" : null)">
                ✅ Disponible
            </option>
            <option value="Prestado" selected="@(ViewBag.EstadoSeleccionado == "Prestado" ? "selected" : null)">
                📦 Prestado
            </option>
        </select>
    </div>
    <div class="col-md-2 align-self-end">
        <button type="button" id="btnResetFiltros" class="btn btn-secondary w-100">
            🧹 Borrar filtros
        </button>
    </div>
</div>

<div class="table-responsive">
    <table id="tablaMateriales" class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>N° Catálogo</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Materia</th>
                <th>Cantidad</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var libro in Model)
            {
                <tr>
                    <td align="center">@libro.NumeroCatalogo</td>
                    <td>@libro.Titulo</td>
                    <td>@libro.Autor</td>
                    <td align="center">@string.Join(", ", libro.Materias)</td>
                    <td align="center" class="fw-bold @(libro.Cantidad == 0 ? "text-danger" : "")">
                        @(libro.Cantidad > 0 ? libro.Cantidad.ToString() : "❌ Agotado")
                    </td>
                    <td align="center">
                        @(libro.Estado == "Disponible" ? "✅ Disponible" : "📦 Prestado")
                    </td>
                    <td class="text-nowrap">
                        <a asp-action="Details" asp-route-id="@libro.Id" class="btn btn-info btn-sm me-1">
                            👁️ Ver
                        </a>
                        <a asp-action="Edit" asp-route-id="@libro.Id" class="btn btn-warning btn-sm me-1">
                            ✏️ Editar
                        </a>
                        <a asp-action="Delete" asp-route-id="@libro.Id" class="btn btn-danger btn-sm me-1">
                            🗑️ Eliminar
                        </a>
                        <a asp-controller="Prestamos" asp-action="Create" asp-route-materialId="@libro.Id" class="btn btn-success btn-sm">
                            ➕ Préstamo
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="loadingMessage">Generando archivo Excel...</h5>
            <p class="text-muted">Esto puede tardar algunos segundos.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

    <script>
        $(document).ready(function () {
            var table = $('#tablaMateriales').DataTable({
                "order": [],
                "columnDefs": [
                    { "orderable": false, "targets": -1 }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                },
                "searching": true
            });

            // Búsqueda predictiva
            $('#tituloInput').on('input', function () {
                table.column(1).search(this.value, true, false).draw();
            });

            $('#autorInput').on('input', function () {
                table.column(2).search(this.value, true, false).draw();
            });

            $('#materiaSelect').on('change', function () {
                table.column(3).search(this.value).draw();
            });

            $('#estadoSelect').on('change', function () {
                table.column(5).search(this.value).draw();
            });

            // Botón Borrar filtros
            $('#btnResetFiltros').on('click', function () {
                $('#tituloInput').val('');
                $('#autorInput').val('');
                $('#materiaSelect').val('');
                $('#estadoSelect').val('');
                table.columns().search('').draw();
            });
        });

                $("#btnExportarExcel").on("click", function () {

            // Mostrar modal
            var modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();

            // Cambiar mensaje dinámicamente
            $("#loadingMessage").text("Generando archivo Excel...");

            // Iniciar descarga REAL
            window.location.href = '@Url.Action("ExportarBibliotecaCompletaExcel", "MaterialBibliografico")';


            // 👀 Función que verifica cada 500ms si la cookie apareció
            let checkCookie = setInterval(function () {

                if (document.cookie.split("; ").includes("excelReady=1")) {

                    $("#loadingMessage").text("Archivo listo. Iniciando descarga...");

                    clearInterval(checkCookie);

                    setTimeout(() => {
                        modal.hide();

                        // borrar cookie para próximas descargas
                        document.cookie = "excelReady=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    }, 1000);
                }

            }, 500);
        });
    </script>
}
