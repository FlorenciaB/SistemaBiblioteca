@model IEnumerable<SistemaBiblioteca.Models.Prestamo>

@{
    ViewData["Title"] = "Préstamos";
    var estadoSeleccionado = ViewBag.EstadoSeleccionado as string;
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
}

<div class="container mt-5">

    <h2 class="mb-4">📚 Préstamos</h2>

    <div class="table-responsive">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        <table id="tablaPrestamos" class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Título</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Grado</th>
                    <th>📅 Fecha de Préstamo</th>
                    <th>⏰ Fecha Límite</th>
                    <th>📌 Fecha de Devolución</th>
                    <th>📄 PDF</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var prestamo in Model)
                {
                    var isVencido = prestamo.FechaDevolucion == null && prestamo.FechaLimiteDevolucion < DateTime.Now;
                    <tr class="@(isVencido ? "table-danger" : "")">
                        <td>@prestamo.MaterialBibliografico?.Titulo</td>
                        <td>@prestamo.NombreNino</td>
                        <td>@prestamo.ApellidoNino</td>
                        <td>@prestamo.GradoNino</td>
                        <td data-order="@prestamo.FechaPrestamo.Ticks">@prestamo.FechaPrestamo.ToShortDateString()</td>
                        <td data-order="@prestamo.FechaLimiteDevolucion.Ticks">@prestamo.FechaLimiteDevolucion.ToShortDateString()</td>
                        <td data-order="@(prestamo.FechaDevolucion?.Ticks ?? long.MaxValue)">
                            @(prestamo.FechaDevolucion?.ToShortDateString() ?? "Activo")
                        </td>
                        <td>
                            <a class="btn btn-sm btn-primary" asp-controller="ComprobantePrestamoPdf" asp-action="Ver" asp-route-prestamoId="@prestamo.Id" target="_blank">
                                📄 Ver PDF
                            </a>
                        </td>
                        <td>
                            @if (User.IsInRole("Admin"))
                            {
                                if (prestamo.FechaDevolucion == null)
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-success"
                                            data-bs-toggle="modal"
                                            data-bs-target="#confirmarModal"
                                            data-prestamo-id="@prestamo.Id">
                                        ✅ Devolver
                                    </button>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Devuelto</span>
                                }
                            }
                            else
                            {
                                <span class="badge @(prestamo.FechaDevolucion == null ? "bg-warning text-dark" : "bg-secondary")">
                                    @(prestamo.FechaDevolucion == null ? "Activo" : "Devuelto")
                                </span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="modal fade" id="confirmarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Confirmar devolución</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-0">¿Querés marcar este préstamo como <strong>devuelto</strong>?</p>
                </div>
                <div class="modal-footer">
                    <form id="formDevolver" method="post" asp-controller="Prestamos" asp-action="Devolver">
                        @Html.AntiForgeryToken()
                        <!-- El action se completa dinámicamente con el id -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Sí, devolver</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

        <script>
            $(document).ready(function () {
                $('#tablaPrestamos').DataTable({
                    "order": [[5, "asc"]], // ordena por fecha límite al cargar
                    "columnDefs": [
                        { "orderable": false, "targets": [7, 8] } // PDF y Acciones no ordenables
                    ],
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                    },
                    "searching": false
                });
            });
            const modal = document.getElementById('confirmarModal');
            modal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Botón que abrió el modal
                const prestamoId = button.getAttribute('data-prestamo-id'); // Obtenemos el id
                const form = document.getElementById('formDevolver');
                // Seteamos la acción del form dinámicamente
                form.action = `/Prestamos/Devolver/${prestamoId}`;
            });
        </script>
}

